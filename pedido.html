// js/pedido.js - Enhanced with new features while preserving original fetch logic

// ==========================================
// ORIGINAL FETCH LOGIC - DO NOT MODIFY
// ==========================================

// Global variables
let productos = [];
let carrito = [];
let currentStep = 1;
let currentPizza = null;

// Original fetch function - preserved as is
async function cargarPlatos() {
    try {
        const response = await fetch('data/platos.json'); // Your existing endpoint
        const data = await response.json();
        productos = data.platos || data; // Handle different JSON structures
        renderProducts();
        console.log('Platos cargados:', productos.length);
    } catch (error) {
        console.error('Error cargando platos:', error);
        showNotification('Error cargando el menú', 'error');
    }
}

// ==========================================
// NEW ENHANCED FEATURES
// ==========================================

// Initialize app
document.addEventListener('DOMContentLoaded', () => {
    cargarPlatos(); // Use original fetch function
    initializeEventListeners();
    loadSessionData();
    updateCartUI();
    checkCrossSelling();
});

// Event listeners setup
function initializeEventListeners() {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', debounce(handleSearch, 300));
    
    // Category tabs
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            setActiveCategory(e.target.dataset.category);
        });
    });
    
    // Pizza modal form changes
    document.addEventListener('change', (e) => {
        if (e.target.closest('#pizzaModal')) {
            updatePizzaPrice();
        }
    });
    
    // Form validation on input
    document.addEventListener('input', (e) => {
        if (e.target.closest('#deliveryForm')) {
            validateField(e.target);
        }
    });
    
    // Keyboard navigation
    document.addEventListener('keydown', handleKeyboardNavigation);
}

// Render products with enhanced features
function renderProducts(filteredProducts = productos) {
    const grid = document.getElementById('productsGrid');
    grid.innerHTML = '';
    
    filteredProducts.forEach(producto => {
        const card = createProductCard(producto);
        grid.appendChild(card);
    });
    
    // Add lazy loading intersection observer
    const images = grid.querySelectorAll('img[data-src]');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                observer.unobserve(img);
            }
        });
    });
    
    images.forEach(img => imageObserver.observe(img));
}

// Create enhanced product card
function createProductCard(producto) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    // Determine badges
    const badges = getProductBadges(producto);
    const badgesHTML = badges.map(badge => 
        `<span class="product-badge ${badge.type}">${badge.icon} ${badge.text}</span>`
    ).join('');
    
    // Set image priority
    const isPriority = producto.featured || producto.categoria === 'pizzas';
    const imageAttrs = isPriority ? 
        'fetchpriority="high"' : 
        'loading="lazy" data-src="' + producto.imagen + '"';
    
    card.innerHTML = `
        <div class="relative">
            <img 
                ${isPriority ? 'src="' + producto.imagen + '"' : ''}
                ${imageAttrs}
                alt="${producto.nombre}"
                class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-200"
                width="300"
                height="192"
                onerror="this.src='assets/placeholder.svg'"
            >
            ${badges.length ? `<div class="absolute top-2 left-2 space-y-1">${badgesHTML}</div>` : ''}
        </div>
        <div class="p-4">
            <h3 class="font-semibold text-lg text-gray-900 mb-1">${producto.nombre}</h3>
            ${producto.ingredientes ? `<p class="text-sm text-gray-600 mb-3">${producto.ingredientes}</p>` : ''}
            <div class="flex items-center justify-between">
                <span class="text-xl font-bold text-red-600">${producto.precio}€</span>
                <button 
                    onclick="${producto.categoria === 'pizzas' ? `openPizzaModal('${producto.id}')` : `addToCart('${producto.id}')`}"
                    class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition-colors focus-ring"
                    aria-label="Añadir ${producto.nombre} al carrito"
                >
                    Añadir
                </button>
            </div>
        </div>
    `;
    
    return card;
}

// Get product badges based on properties
function getProductBadges(producto) {
    const badges = [];
    
    // TODO: Add these flags to your JSON data if missing
    if (producto.picante || producto.spicy) {
        badges.push({ type: 'spicy', icon: '🌶️', text: 'Picante' });
    }
    if (producto.vegetariano || producto.veggie) {
        badges.push({ type: 'veggie', icon: '🥬', text: 'Veggie' });
    }
    if (producto.sinGluten || producto.glutenFree) {
        badges.push({ type: 'gluten-free', icon: '🚫🌾', text: 'Sin gluten' });
    }
    if (producto.masVendido || producto.bestseller) {
        badges.push({ type: 'bestseller', icon: '⭐', text: 'Top ventas' });
    }
    
    return badges;
}

// Pizza customization modal
function openPizzaModal(productId) {
    const pizza = productos.find(p => p.id === productId);
    if (!pizza) return;
    
    currentPizza = { ...pizza };
    
    document.getElementById('modalPizzaName').textContent = pizza.nombre;
    document.getElementById('pizzaModal').classList.remove('hidden');
    
    // Reset form
    document.querySelectorAll('#pizzaModal input[type="radio"]').forEach(input => {
        input.checked = input.value === 'small' || input.value === 'thin';
    });
    document.querySelectorAll('#pizzaModal input[type="checkbox"]').forEach(input => {
        input.checked = false;
    });
    document.getElementById('pizzaNotes').value = '';
    
    updatePizzaPrice();
    
    // Focus management for accessibility
    setTimeout(() => {
        document.querySelector('#pizzaModal input[type="radio"]').focus();
    }, 100);
    
    // Prevent body scroll
    document.body.style.overflow = 'hidden';
}

function closePizzaModal() {
    document.getElementById('pizzaModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
    currentPizza = null;
}

function updatePizzaPrice() {
    if (!currentPizza) return;
    
    let totalPrice = currentPizza.precio;
    
    // Add size price
    const sizeInput = document.querySelector('input[name="pizzaSize"]:checked');
    if (sizeInput) {
        totalPrice += parseFloat(sizeInput.dataset.price);
    }
    
    // Add dough price
    const doughInput = document.querySelector('input[name="pizzaDough"]:checked');
    if (doughInput) {
        totalPrice += parseFloat(doughInput.dataset.price);
    }
    
    // Add toppings prices
    const toppings = document.querySelectorAll('input[name="extraToppings"]:checked');
    toppings.forEach(topping => {
        totalPrice += parseFloat(topping.dataset.price);
    });
    
    document.getElementById('modalPizzaPrice').textContent = totalPrice.toFixed(2) + '€';
}

function addCustomPizzaToCart() {
    if (!currentPizza) return;
    
    const size = document.querySelector('input[name="pizzaSize"]:checked')?.value || 'small';
    const dough = document.querySelector('input[name="pizzaDough"]:checked')?.value || 'thin';
    const toppings = Array.from(document.querySelectorAll('input[name="extraToppings"]:checked'))
        .map(input => input.value);
    const notes = document.getElementById('pizzaNotes').value;
    
    const customPizza = {
        ...currentPizza,
        id: currentPizza.id + '_' + Date.now(), // Unique ID for custom pizza
        customization: {
            size,
            dough,
            toppings,
            notes
        },
        finalPrice: parseFloat(document.getElementById('modalPizzaPrice').textContent.replace('€', ''))
    };
    
    carrito.push(customPizza);
    
    // Analytics event
    gtag('event', 'add_to_cart', {
        currency: 'EUR',
        value: customPizza.finalPrice,
        items: [{
            item_id: customPizza.id,
            item_name: customPizza.nombre,
            category: 'pizzas',
            quantity: 1,
            price: customPizza.finalPrice
        }]
    });
    
    // Facebook Pixel event
    fbq('track', 'AddToCart', {
        content_ids: [customPizza.id],
        content_type: 'product',
        value: customPizza.finalPrice,
        currency: 'EUR'
    });
    
    updateCartUI();
    saveSessionData();
    showNotification(`${customPizza.nombre} añadido al carrito`, 'success');
    closePizzaModal();
    checkCrossSelling();
}

// Regular add to cart for non-pizza items
function addToCart(productId) {
    const producto = productos.find(p => p.id === productId);
    if (!producto) return;
    
    const existingItem = carrito.find(item => item.id === productId && !item.customization);
    
    if (existingItem) {
        existingItem.quantity = (existingItem.quantity || 1) + 1;
    } else {
        carrito.push({
            ...producto,
            quantity: 1,
            finalPrice: producto.precio
        });
    }
    
    // Analytics events
    gtag('event', 'add_to_cart', {
        currency: 'EUR',
        value: producto.precio,
        items: [{
            item_id: producto.id,
            item_name: producto.nombre,
            category: producto.categoria,
            quantity: 1,
            price: producto.precio
        }]
    });
    
    fbq('track', 'AddToCart', {
        content_ids: [producto.id],
        content_type: 'product',
        value: producto.precio,
        currency: 'EUR'
    });
    
    updateCartUI();
    saveSessionData();
    showNotification(`${producto.nombre} añadido al carrito`, 'success');
    checkCrossSelling();
}

// Cart management
function updateCartUI() {
    const total = carrito.reduce((sum, item) => sum + (item.finalPrice * (item.quantity || 1)), 0);
    const itemCount = carrito.reduce((sum, item) => sum + (item.quantity || 1), 0);
    
    // Update cart badge
    const badge = document.getElementById('cartBadge');
    if (itemCount > 0) {
        badge.textContent = itemCount;
        badge.classList.remove('hidden');
    } else {
        badge.classList.add('hidden');
    }
    
    // Update sticky bar
    const stickyBar = document.getElementById('stickyBar');
    const stickyTotal = document.getElementById('stickyTotal');
    
    if (carrito.length > 0) {
        stickyBar.classList.remove('hidden');
        stickyTotal.textContent = total.toFixed(2) + '€';
    } else {
        stickyBar.classList.add('hidden');
    }
    
    // Update all total displays
    document.querySelectorAll('#cartTotal, #cartSlideTotal, #finalTotal').forEach(el => {
        if (el) el.textContent = total.toFixed(2) + '€';
    });
}

// Cross-selling logic
function checkCrossSelling() {
    const hasPizza = carrito.some(item => item.categoria === 'pizzas');
    const hasBebida = carrito.some(item => item.categoria === 'bebidas');
    const hasHelado = carrito.some(item => item.categoria === 'helados');
    
    const banner = document.getElementById('crossSellBanner');
    
    if (hasPizza && (!hasBebida || !hasHelado)) {
        banner.classList.remove('hidden');
    } else {
        banner.classList.add('hidden');
    }
}

function addComboOffer() {
    // Find a default bebida and helado
    const bebida = productos.find(p => p.categoria === 'bebidas');
    const helado = productos.find(p => p.categoria === 'helados');
    
    if (bebida && !carrito.some(item => item.categoria === 'bebidas')) {
        addToCart(bebida.id);
    }
    
    if (helado && !carrito.some(item => item.categoria === 'helados')) {
        addToCart(helado.id);
    }
    
    // TODO: Apply 1€ discount in backend
    showNotification('Combo añadido con descuento de 1€', 'success');
}

// Checkout wizard
function showCheckout() {
    document.getElementById('menuView').classList.add('hidden');
    document.getElementById('checkoutWizard').classList.remove('hidden');
    document.getElementById('progressSteps').classList.remove('hidden');
    
    goToStep(1);
    renderCartItems();
    
    // Analytics event
    gtag('event', 'begin_checkout', {
        currency: 'EUR',
        value: carrito.reduce((sum, item) => sum + (item.finalPrice * (item.quantity || 1)), 0)
    });
    
    fbq('track', 'InitiateCheckout', {
        value: carrito.reduce((sum, item) => sum + (item.finalPrice * (item.quantity || 1)), 0),
        currency: 'EUR',
        num_items: carrito.length
    });
}

function goToStep(step) {
    // Hide all steps
    document.querySelectorAll('.checkout-step').forEach(stepEl => {
        stepEl.classList.add('hidden');
    });
    
    // Show current step
    document.getElementById(`step${step}`).classList.remove('hidden');
    
    // Update progress
    updateProgressSteps(step);
    currentStep = step;
    
    saveSessionData();
}

function updateProgressSteps(currentStep) {
    document.querySelectorAll('[data-step]').forEach((stepEl, index) => {
        const stepNumber = parseInt(stepEl.dataset.step);
        const circle = stepEl.querySelector('.step-circle');
        const line = stepEl.querySelector('.step-line div');
        
        if (stepNumber < currentStep) {
            stepEl.className = stepEl.className.replace(/text-\w+-\d+/, 'text-green-600');
            circle.className = circle.className.replace(/bg-\w+-\d+/, 'bg-green-100').replace(/ring-\w+-\d+/, 'ring-green-100');
            circle.querySelector('span').className = 'text-green-800 text-sm font-semibold';
            if (line) line.style.width = '100%';
        } else if (stepNumber === currentStep) {
            stepEl.className = stepEl.className.replace(/text-\w+-\d+/, 'text-blue-600');
            circle.className = circle.className.replace(/bg-\w+-\d+/, 'bg-blue-100').replace(/ring-\w+-\d+/, 'ring-blue-100');
            circle.querySelector('span').className = 'text-blue-800 text-sm font-semibold';
            if (line) line.style.width = '100%';
        } else {
            stepEl.className = stepEl.className.replace(/text-\w+-\d+/, 'text-gray-500');
            circle.className = circle.className.replace(/bg-\w+-\d+/, 'bg-gray-100').replace(/ring-\w+-\d+/, 'ring-gray-100');
            circle.querySelector('span').className = 'text-gray-800 text-sm font-semibold';
            if (line) line.style.width = '0%';
        }
    });
}

function renderCartItems() {
    const container = document.getElementById('cartItems');
    container.innerHTML = '';
    
    carrito.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
        
        const customizationText = item.customization ? 
            `<div class="text-xs text-gray-500 mt-1">
                ${item.customization.size} • ${item.customization.dough}
                ${item.customization.toppings.length ? ' • ' + item.customization.toppings.join(', ') : ''}
            </div>` : '';
        
        itemEl.innerHTML = `
            <div class="flex-1">
                <h4 class="font-medium">${item.nombre}</h4>
                ${customizationText}
                <div class="text-sm text-gray-600">Cantidad: ${item.quantity || 1}</div>
            </div>
            <div class="text-right">
                <div class="font-semibold">${(item.finalPrice * (item.quantity || 1)).toFixed(2)}€</div>
                <div class="flex items-center space-x-2 mt-2">
                    ${item.categoria === 'pizzas' && item.customization ? 
                        `<button onclick="editPizza(${index})" class="text-blue-600 hover:text-blue-800 text-sm">Editar</button>` : ''
                    }
                    <button onclick="removeFromCart(${index})" class="text-red-600 hover:text-red-800 text-sm">Eliminar</button>
                </div>
            </div>
        `;
        
        container.appendChild(itemEl);
    });
}

function removeFromCart(index) {
    carrito.splice(index, 1);
    updateCartUI();
    renderCartItems();
    saveSessionData();
    checkCrossSelling();
}

function editPizza(index) {
    const pizza = carrito[index];
    if (pizza.categoria === 'pizzas' && pizza.customization) {
        // Remove from cart temporarily
        carrito.splice(index, 1);
        updateCartUI();
        
        // Open modal with existing customization
        openPizzaModal(pizza.id.split('_')[0]); // Remove timestamp suffix
        
        // Pre-fill the form
        setTimeout(() => {
            document.querySelector(`input[name="pizzaSize"][value="${pizza.customization.size}"]`).checked = true;
            document.querySelector(`input[name="pizzaDough"][value="${pizza.customization.dough}"]`).checked = true;
            
            pizza.customization.toppings.forEach(topping => {
                const checkbox = document.querySelector(`input[name="extraToppings"][value="${topping}"]`);
                if (checkbox) checkbox.checked = true;
            });
            
            document.getElementById('pizzaNotes').value = pizza.customization.notes || '';
            updatePizzaPrice();
        }, 100);
    }
}

// Form validation
function validateField(field) {
    const errorEl = document.getElementById(field.name + '-error');
    let isValid = true;
    let errorMessage = '';
    
    if (field.hasAttribute('required') && !field.value.trim()) {
        isValid = false;
        errorMessage = 'Este campo es obligatorio';
    } else if (field.type === 'email' && field.value && !isValidEmail(field.value)) {
        isValid = false;
        errorMessage = 'Email no válido';
    } else if (field.type === 'tel' && field.value && !isValidPhone(field.value)) {
        isValid = false;
        errorMessage = 'Teléfono no válido';
    } else if (field.pattern && field.value && !new RegExp(field.pattern).test(field.value)) {
        isValid = false;
        errorMessage = 'Formato no válido';
    }
    
    if (errorEl) {
        if (isValid) {
            errorEl.classList.add('hidden');
            field.classList.remove('border-red-500');
            field.setAttribute('aria-invalid', 'false');
        } else {
            errorEl.textContent = errorMessage;
            errorEl.classList.remove('hidden');
            field.classList.add('border-red-500');
            field.setAttribute('aria-invalid', 'true');
        }
    }
    
    return isValid;
}

function validateAndGoToStep3() {
    const form = document.getElementById('deliveryForm');
    const fields = form.querySelectorAll('input[required]');
    let allValid = true;
    
    fields.forEach(field => {
        if (!validateField(field)) {
            allValid = false;
        }
    });
    
    if (allValid) {
        goToStep(3);
    } else {
        showNotification('Por favor, completa todos los campos obligatorios', 'error');
        // Focus first invalid field
        const firstInvalid = form.querySelector('[aria-invalid="true"]');
        if (firstInvalid) firstInvalid.focus();
    }
}

// Purchase completion
async function completePurchase() {
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    
    if (!paymentMethod) {
        showNotification('Selecciona un método de pago', 'error');
        return;
    }
    
    // Show loading
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Procesando...';
    button.disabled = true;
    
    try {
        // ReCAPTCHA verification
        const captchaToken = await verifyCaptcha();
        
        // TODO: Send order to backend
        const orderData = {
            items: carrito,
            delivery: getFormData('deliveryForm'),
            payment: paymentMethod,
            total: carrito.reduce((sum, item) => sum + (item.finalPrice * (item.quantity || 1)), 0),
            captchaToken
        };
        
        console.log('Order data:', orderData);
        
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Analytics events
        const total = orderData.total;
        
        gtag('event', 'purchase', {
            transaction_id: 'ORDER_' + Date.now(),
            value: total,
            currency: 'EUR',
            items: carrito.map(item => ({
                item_id: item.id,
                item_name: item.nombre,
                category: item.categoria,
                quantity: item.quantity || 1,
                price: item.finalPrice
            }))
        });
        
        fbq('track', 'Purchase', {
            value: total,
            currency: 'EUR',
            content_ids: carrito.map(item => item.id),
            content_type: 'product'
        });
        
        // Clear cart and redirect
        carrito = [];
        clearSessionData();
        updateCartUI();
        
        showNotification('¡Pedido confirmado! Recibirás un email de confirmación.', 'success');
        
        // TODO: Redirect to confirmation page
        setTimeout(() => {
            window.location.href = 'confirmation.html';
        }, 2000);
        
    } catch (error) {
        console.error('Error completing purchase:', error);
        showNotification('Error procesando el pedido. Inténtalo de nuevo.', 'error');
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}

// ReCAPTCHA verification
async function verifyCaptcha() {
    return new Promise((resolve, reject) => {
        grecaptcha.ready(() => {
            grecaptcha.execute('[YOUR_RECAPTCHA_SITE_KEY]', { action: 'purchase' })
                .then(token => {
                    // TODO: Verify token on backend
                    resolve(token);
                })
                .catch(reject);
        });
    });
}

// Utility functions
function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function isValidPhone(phone) {
    return /^[+]?[\d\s-()]{9,}$/.test(phone);
}

function getFormData(formId) {
    const form = document.getElementById(formId);
    const formData = new FormData(form);
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    return data;
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Session storage management
function saveSessionData() {
    sessionStorage.setItem('fratelli_cart', JSON.stringify(carrito));
    sessionStorage.setItem('fratelli_step', currentStep.toString());
    
    if (currentStep >= 2) {
        const deliveryData = getFormData('deliveryForm');
        sessionStorage.setItem('fratelli_delivery', JSON.stringify(deliveryData));
    }
}

function loadSessionData() {
    const savedCart = sessionStorage.getItem('fratelli_cart');
    const savedStep = sessionStorage.getItem('fratelli_step');
    
    if (savedCart) {
        carrito = JSON.parse(savedCart);
    }
    
    if (savedStep) {
        currentStep = parseInt(savedStep);
    }
    
    // Restore delivery form if in checkout
    if (currentStep >= 2) {
        const savedDelivery = sessionStorage.getItem('fratelli_delivery');
        if (savedDelivery) {
            const deliveryData = JSON.parse(savedDelivery);
            Object.entries(deliveryData).forEach(([key, value]) => {
                const field = document.getElementById(key);
                if (field) field.value = value;
            });
        }
    }
}

function clearSessionData() {
    sessionStorage.removeItem('fratelli_cart');
    sessionStorage.removeItem('fratelli_step');
    sessionStorage.removeItem('fratelli_delivery');
}

// Search and filtering
function handleSearch(event) {
    const query = event.target.value.toLowerCase().trim();
    
    if (!query) {
        renderProducts();
        return;
    }
    
    const filtered = productos.filter(producto => 
        producto.nombre.toLowerCase().includes(query) ||
        (producto.ingredientes && producto.ingredientes.toLowerCase().includes(query)) ||
        producto.categoria.toLowerCase().includes(query)
    );
    
    renderProducts(filtered);
    
    // Show empty message if no results
    if (filtered.length === 0) {
        const grid = document.getElementById('productsGrid');
        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <div class="text-gray-400 text-4xl mb-4">🔍</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No se encontraron productos</h3>
                <p class="text-gray-600">No hay productos que coincidan con "${query}"</p>
            </div>
        `;
    }
}

function setActiveCategory(category) {
    // Update tab styles
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelector(`[data-category="${category}"]`).classList.add('active');
    
    // Filter products
    if (category === 'all') {
        renderProducts();
    } else {
        const filtered = productos.filter(producto => producto.categoria === category);
        renderProducts(filtered);
    }
}

// Notifications system
function showNotification(message, type = 'success') {
    const container = document.getElementById('notifications');
    const notification = document.createElement('div');
    
    notification.className = `notification ${type}`;
    notification.setAttribute('role', 'alert');
    notification.setAttribute('aria-live', 'polite');
    
    const icon = type === 'success' ? '✓' : type === 'error' ? '✗' : 'ℹ';
    
    notification.innerHTML = `
        <div class="flex items-center">
            <span class="mr-2">${icon}</span>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-gray-400 hover:text-gray-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;
    
    container.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Keyboard navigation
function handleKeyboardNavigation(event) {
    // Escape key to close modals
    if (event.key === 'Escape') {
        if (!document.getElementById('pizzaModal').classList.contains('hidden')) {
            closePizzaModal();
        }
        if (!document.getElementById('cartSlide').classList.contains('hidden')) {
            closeCartSlide();
        }
    }
    
    // Enter key on buttons
    if (event.key === 'Enter' && event.target.tagName === 'BUTTON') {
        event.target.click();
    }
}

// Cart slide functionality
function showCartSlide() {
    const slide = document.getElementById('cartSlide');
    slide.classList.remove('hidden');
    setTimeout(() => {
        slide.classList.remove('translate-x-full');
    }, 10);
    
    renderCartSlideItems();
}

function closeCartSlide() {
    const slide = document.getElementById('cartSlide');
    slide.classList.add('translate-x-full');
    setTimeout(() => {
        slide.classList.add('hidden');
    }, 300);
}

function renderCartSlideItems() {
    const container = document.getElementById('cartSlideItems');
    container.innerHTML = '';
    
    if (carrito.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8">
                <div class="text-gray-400 text-4xl mb-4">🛒</div>
                <p class="text-gray-600">Tu carrito está vacío</p>
            </div>
        `;
        return;
    }
    
    carrito.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg mb-3';
        
        itemEl.innerHTML = `
            <div class="flex-1">
                <h4 class="font-medium text-sm">${item.nombre}</h4>
                <div class="text-xs text-gray-500">Cantidad: ${item.quantity || 1}</div>
                <div class="text-sm font-semibold text-red-600">${(item.finalPrice * (item.quantity || 1)).toFixed(2)}€</div>
            </div>
            <button onclick="removeFromCart(${index})" class="text-red-600 hover:text-red-800">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
        `;
        
        container.appendChild(itemEl);
    });
}

// Make functions globally available
window.openPizzaModal = openPizzaModal;
window.closePizzaModal = closePizzaModal;
window.addCustomPizzaToCart = addCustomPizzaToCart;
window.addToCart = addToCart;
window.removeFromCart = removeFromCart;
window.editPizza = editPizza;
window.showCheckout = showCheckout;
window.goToStep = goToStep;
window.validateAndGoToStep3 = validateAndGoToStep3;
window.completePurchase = completePurchase;
window.addComboOffer = addComboOffer;
window.showCartSlide = showCartSlide;
window.closeCartSlide = closeCartSlide;
